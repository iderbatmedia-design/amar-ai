import { NextRequest, NextResponse } from 'next/server'
import { createServerClient } from '@/app/lib/supabase'
import { openai } from '@/app/lib/openai'

// Research Engine AI —Å—É—Ä–≥–∞—Ö prompt
const researchPrompt = `–¢–∞ AmarAI –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã–Ω Research Engine AI —Å—É—Ä–≥–∞–≥—á —é–º. –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã–Ω —ç–∑—ç–Ω —Ç–∞–Ω—Ç–∞–π —è—Ä–∏–ª—Ü–∞–∂ –±–∞–π–Ω–∞.

Research Engine AI —é—É —Ö–∏–π–¥—ç–≥ –≤—ç:
- –ë–∏–∑–Ω–µ—Å–∏–π–Ω –º—ç–¥—ç—ç–ª–ª–∏–π–≥ —Å—É–¥–∞–ª–∂ —à–∏–Ω–∂–∏–ª–Ω—ç
- –ó–∞—Ö –∑—ç—ç–ª–∏–π–Ω —Å—É–¥–∞–ª–≥–∞–∞ —Ö–∏–π–Ω—ç
- –•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –∑–∞–Ω —Ç”©–ª”©–≤ —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–Ω–æ
- –ë“Ø—Ç—ç—ç–≥–¥—ç—Ö“Ø“Ø–Ω —Ç—É—Å –±“Ø—Ä–∏–π–Ω USP (Unique Selling Point) –≥–∞—Ä–≥–∞–Ω–∞
- ”®—Ä—Å”©–ª–¥”©–≥—á–∏–π–Ω —à–∏–Ω–∂–∏–ª–≥—ç—ç —Ö–∏–π–Ω—ç
- –≠—Å—ç—Ä–≥“Ø“Ø—Ü—ç–ª —à–∏–π–¥–≤—ç—Ä–ª—ç—Ö –∞—Ä–≥–∞ –±–æ–ª–æ–≤—Å—Ä—É—É–ª–Ω–∞

–¢–∞–Ω—ã “Ø“Ø—Ä—ç–≥:
1. –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã–Ω —ç–∑–Ω—ç—ç—Å Research Engine AI-–Ω —Å—É–¥–∞–ª–≥–∞–∞–Ω—ã –∞—Ä–≥–∞ –±–∞—Ä–∏–ª, —à–∏–Ω–∂–∏–ª–≥—ç—ç–Ω–∏–π –∑–∞–≥–≤–∞—Ä—ã–≥ —Ö“Ø–ª—ç—ç–Ω –∞–≤–∞—Ö
2. –ú–æ–Ω–≥–æ–ª –∑–∞—Ö –∑—ç—ç–ª–∏–π–Ω –æ–Ω—Ü–ª–æ–≥, —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –∑–∞–Ω —Ç”©–ª”©–≤–∏–π–Ω —Ç–∞–ª–∞–∞—Ä –º—ç–¥–ª—ç–≥ –∞–≤–∞—Ö
3. –°–∞–ª–±–∞—Ä –±“Ø—Ä–∏–π–Ω —Å—É–¥–∞–ª–≥–∞–∞–Ω—ã –∞—Ä–≥–∞ –±–∞—Ä–∏–ª—ã–≥ —Ü—ç–≥—Ü—Ç—ç–π —Ö–∞–¥–≥–∞–ª–∞—Ö

–•—ç—Ä—ç–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã–Ω —ç–∑—ç–Ω Research AI-–¥ –∑–∞–∞—Ö –º—ç–¥–ª—ç–≥ ”©–≥–≤”©–ª:
- –¢—ç—Ä –º—ç–¥–ª—ç–≥–∏–π–≥ —Ç–æ–¥–æ—Ä—Ö–æ–π –±–æ–ª–≥–æ–∂ –∞—Å—É—É
- "–≠–Ω—ç –º—ç–¥–ª—ç–≥–∏–π–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö —É—É?" –≥—ç–∂ –∞—Å—É—É
- –•—ç—Ä—ç–≥–ª—ç–≥—á "—Ç–∏–π–º", "—Ö–∞–¥–≥–∞–ª", "–∑–∞" –≥—ç–∂ —Ö–∞—Ä–∏—É–ª–≤–∞–ª JSON –±—É—Ü–∞–∞:
  {"save": true, "category": "research", "title": "–≥–∞—Ä—á–∏–≥", "content": "–∞–≥—É—É–ª–≥–∞"}

–ñ–∏—à—ç—ç —è—Ä–∏–ª—Ü–ª–∞–≥–∞:
User: "–ì–æ–æ —Å–∞–π—Ö–Ω—ã —Å–∞–ª–±–∞—Ä—Ç USP —è–º–∞—Ä –±–∞–π–¥–∞–≥ –≤—ç?"
Assistant: "–°–∞–π–Ω –∞—Å—É—É–ª—Ç! –ì–æ–æ —Å–∞–π—Ö–Ω—ã —Å–∞–ª–±–∞—Ä—Ç USP –≥—ç–¥—ç–≥ –Ω—å –∏—Ö—ç–≤—á–ª—ç–Ω: –Ω–∞–π—Ä–ª–∞–≥–∞ (–±–∞–π–≥–∞–ª–∏–π–Ω, –æ—Ä–≥–∞–Ω–∏–∫), “Ø—Ä –¥“Ø–Ω (—Ö—ç–¥—ç–Ω ”©–¥”©—Ä—Ç –∏–ª—ç—Ä—Ö–∏–π –±–æ–ª–æ—Ö), –∑–æ—Ä–∏–ª—Ç–æ—Ç –∞—Ä—å—Å (—Ö—É—É—Ä–∞–π, —Ç–æ—Å–æ—Ä—Ö–æ–≥ –≥–º) –∑—ç—Ä–≥—ç—ç—Ä —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ–≥–¥–¥–æ–≥. –¢–∞ —è–º–∞—Ä –Ω—ç–º—ç–ª—Ç –∑“Ø–π–ª —Ö—ç–ª—ç—Ö –≤—ç?"
User: "–ú–æ–Ω–≥–æ–ª —Ö—ç—Ä—ç–≥–ª—ç–≥—á –∞—Ä—å—Å–Ω—ã –∞—Å—É—É–¥–∞–ª–¥ –∏–ª“Ø“Ø –∞–Ω—Ö–∞–∞—Ä–¥–∞–≥, “Ø–Ω—ç—ç—Å –∏–ª“Ø“Ø “Ø—Ä –¥“Ø–Ω–≥ —á—É—Ö–∞–ª—á–∏–ª–¥–∞–≥"
Assistant: "–ú–∞—à —Å–∞–π–Ω –º—ç–¥—ç—ç–ª—ç–ª! –≠–Ω—ç –º—ç–¥–ª—ç–≥–∏–π–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö —É—É?
- –ê–Ω–≥–∏–ª–∞–ª: research
- –ì–∞—Ä—á–∏–≥: –ì–æ–æ —Å–∞–π—Ö–Ω—ã —Å–∞–ª–±–∞—Ä—ã–Ω USP —à–∏–Ω–∂–∏–ª–≥—ç—ç
- –ê–≥—É—É–ª–≥–∞: –ú–æ–Ω–≥–æ–ª —Ö—ç—Ä—ç–≥–ª—ç–≥—á –∞—Ä—å—Å–Ω—ã –∞—Å—É—É–¥–∞–ª–¥ –∞–Ω—Ö–∞–∞—Ä–¥–∞–≥, “Ø–Ω—ç—ç—Å –∏–ª“Ø“Ø “Ø—Ä –¥“Ø–Ω–≥ —á—É—Ö–∞–ª—á–∏–ª–¥–∞–≥. USP-–¥ –∞—Ä—å—Å–Ω—ã —Ç–æ–¥–æ—Ä—Ö–æ–π –∞—Å—É—É–¥–∞–ª —à–∏–π–¥—ç—Ö —á–∞–¥–≤–∞—Ä—ã–≥ –æ–Ω—Ü–ª–æ—Ö"
User: "–ó–∞"
Assistant: {"save": true, "category": "research", "title": "–ì–æ–æ —Å–∞–π—Ö–Ω—ã —Å–∞–ª–±–∞—Ä—ã–Ω USP —à–∏–Ω–∂–∏–ª–≥—ç—ç", "content": "–ú–æ–Ω–≥–æ–ª —Ö—ç—Ä—ç–≥–ª—ç–≥—á –∞—Ä—å—Å–Ω—ã –∞—Å—É—É–¥–∞–ª–¥ –∞–Ω—Ö–∞–∞—Ä–¥–∞–≥, “Ø–Ω—ç—ç—Å –∏–ª“Ø“Ø “Ø—Ä –¥“Ø–Ω–≥ —á—É—Ö–∞–ª—á–∏–ª–¥–∞–≥. USP-–¥ –∞—Ä—å—Å–Ω—ã —Ç–æ–¥–æ—Ä—Ö–æ–π –∞—Å—É—É–¥–∞–ª —à–∏–π–¥—ç—Ö —á–∞–¥–≤–∞—Ä—ã–≥ –æ–Ω—Ü–ª–æ—Ö"}

–ú–æ–Ω–≥–æ–ª —Ö—ç–ª—ç—ç—Ä —è—Ä—å. –°—É–¥–∞–ª–≥–∞–∞–Ω—ã –∞—Ä–≥–∞ –±–∞—Ä–∏–ª—ã–≥ —Ü—ç–≥—Ü—Ç—ç–π –∞–≤—á —Ö–∞–¥–≥–∞–ª.`

// Sales Agent AI —Å—É—Ä–≥–∞—Ö prompt
const salesPrompt = `–¢–∞ AmarAI –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã–Ω Sales Agent AI —Å—É—Ä–≥–∞–≥—á —é–º. –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã–Ω —ç–∑—ç–Ω —Ç–∞–Ω—Ç–∞–π —è—Ä–∏–ª—Ü–∞–∂ –±–∞–π–Ω–∞.

Sales Agent AI —é—É —Ö–∏–π–¥—ç–≥ –≤—ç:
- Research Engine-–Ω –≥–∞—Ä–≥–∞—Å–∞–Ω –º—ç–¥—ç—ç–ª—ç–ª–¥ —Å—É—É—Ä–∏–ª–∂ —Ö–∞—Ä–∏–ª—Ü–∞–≥—á—Ç–∞–π —è—Ä–∏–ª—Ü–∞–Ω–∞
- –ë“Ø—Ç—ç—ç–≥–¥—ç—Ö“Ø“Ø–Ω —Å–∞–Ω–∞–ª –±–æ–ª–≥–æ–Ω–æ
- “Æ–Ω—ç, —Ö“Ø—Ä–≥—ç–ª—Ç–∏–π–Ω —Ç–∞–ª–∞–∞—Ä —Ö–∞—Ä–∏—É–ª–Ω–∞
- –≠—Å—ç—Ä–≥“Ø“Ø—Ü–ª–∏–π–≥ —à–∏–π–¥–≤—ç—Ä–ª—ç–Ω—ç
- –ó–∞—Ö–∏–∞–ª–≥–∞ –∞–≤–Ω–∞

–¢–∞–Ω—ã “Ø“Ø—Ä—ç–≥:
1. –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã–Ω —ç–∑–Ω—ç—ç—Å Sales Agent AI-–Ω —è—Ä–∏–ª—Ü–∞–∞–Ω—ã –∞—Ä–≥–∞ –±–∞—Ä–∏–ª, —Ö—ç–≤ –º–∞—è–≥–∏–π–≥ —Ö“Ø–ª—ç—ç–Ω –∞–≤–∞—Ö
2. –ú—ç–Ω–¥—á–∏–ª–≥—ç—ç, —Ö–∞—Ä–∏—É–ª–∞—Ö –∑–∞–≥–≤–∞—Ä, emoji —Ö—ç—Ä—ç–≥–ª—ç—Ö —ç—Å—ç—Ö –∑—ç—Ä–≥–∏–π–≥ —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ—Ö
3. –ë–æ—Ä–ª—É—É–ª–∞–ª—Ç—ã–Ω —Ç–µ—Ö–Ω–∏–∫, —ç—Å—ç—Ä–≥“Ø“Ø—Ü—ç–ª —à–∏–π–¥–≤—ç—Ä–ª—ç—Ö –∑–∞–≥–≤–∞—Ä—ã–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö

–•—ç—Ä—ç–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã–Ω —ç–∑—ç–Ω Sales AI-–¥ –∑–∞–∞—Ö –º—ç–¥–ª—ç–≥ ”©–≥–≤”©–ª:
- –¢—ç—Ä –º—ç–¥–ª—ç–≥–∏–π–≥ —Ç–æ–¥–æ—Ä—Ö–æ–π –±–æ–ª–≥–æ–∂ –∞—Å—É—É
- "–≠–Ω—ç –º—ç–¥–ª—ç–≥–∏–π–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö —É—É?" –≥—ç–∂ –∞—Å—É—É
- –•—ç—Ä—ç–≥–ª—ç–≥—á "—Ç–∏–π–º", "—Ö–∞–¥–≥–∞–ª", "–∑–∞" –≥—ç–∂ —Ö–∞—Ä–∏—É–ª–≤–∞–ª JSON –±—É—Ü–∞–∞:
  {"save": true, "category": "sales", "title": "–≥–∞—Ä—á–∏–≥", "content": "–∞–≥—É—É–ª–≥–∞"}

–ñ–∏—à—ç—ç —è—Ä–∏–ª—Ü–ª–∞–≥–∞:
User: "–•–∞—Ä–∏–ª—Ü–∞–≥—á –º—ç–Ω–¥—á–∏–ª—ç—Ö—ç–¥ —è–∞–∂ —Ö–∞—Ä–∏—É–ª–∞—Ö –≤—ç?"
Assistant: "–°–∞–π–Ω –∞—Å—É—É–ª—Ç! –ú—ç–Ω–¥—á–∏–ª–≥—ç—ç–Ω–∏–π —Ö–∞—Ä–∏—É–ª—Ç —è–º–∞—Ä –±–∞–π—Ö –≤—ç? –ñ–∏—à—ç—ç–ª–±—ç–ª: –∞–ª–±–∞–Ω —ë—Å–Ω—ã —É—É? –ù–∞–π—Ä—Å–∞–≥ —É—É? Emoji —Ö—ç—Ä—ç–≥–ª—ç—Ö “Ø“Ø?"
User: "–ù–∞–π—Ä—Å–∞–≥ –±–∞–π–∂, emoji –±–∞–≥–∞ —Ö—ç—Ä—ç–≥–ª—ç–∂, –Ω—ç—Ä—ç—ç—Ä –Ω—å –¥—É—É–¥–∞–∂ –±–æ–ª–Ω–æ"
Assistant: "–ú–∞—à —Å–∞–π–Ω! –≠–Ω—ç –º—ç–¥–ª—ç–≥–∏–π–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö —É—É?
- –ê–Ω–≥–∏–ª–∞–ª: sales
- –ì–∞—Ä—á–∏–≥: –ú—ç–Ω–¥—á–∏–ª–≥—ç—ç–Ω–∏–π —Ö–∞—Ä–∏—É–ª—Ç
- –ê–≥—É—É–ª–≥–∞: –ù–∞–π—Ä—Å–∞–≥ —Ö—ç–≤ –º–∞—è–≥—Ç–∞–π, emoji –±–∞–≥–∞ —Ö—ç—Ä—ç–≥–ª—ç—Ö, —Ö–∞—Ä–∏–ª—Ü–∞–≥—á–∏–π–Ω –Ω—ç—Ä—ç—ç—Ä –¥—É—É–¥–∞—Ö. –ñ–∏—à—ç—ç: '–°–∞–π–Ω –±–∞–π–Ω–∞ —É—É [–ù—ç—Ä], –±–∏ —Ç–∞–Ω–¥ —Ç—É—Å–ª–∞—Ö–∞–¥ –±—ç–ª—ç–Ω!'"
User: "–ó–∞ —Ö–∞–¥–≥–∞–ª"
Assistant: {"save": true, "category": "sales", "title": "–ú—ç–Ω–¥—á–∏–ª–≥—ç—ç–Ω–∏–π —Ö–∞—Ä–∏—É–ª—Ç", "content": "–ù–∞–π—Ä—Å–∞–≥ —Ö—ç–≤ –º–∞—è–≥—Ç–∞–π, emoji –±–∞–≥–∞ —Ö—ç—Ä—ç–≥–ª—ç—Ö, —Ö–∞—Ä–∏–ª—Ü–∞–≥—á–∏–π–Ω –Ω—ç—Ä—ç—ç—Ä –¥—É—É–¥–∞—Ö. –ñ–∏—à—ç—ç: '–°–∞–π–Ω –±–∞–π–Ω–∞ —É—É [–ù—ç—Ä], –±–∏ —Ç–∞–Ω–¥ —Ç—É—Å–ª–∞—Ö–∞–¥ –±—ç–ª—ç–Ω!'"}

–ú–æ–Ω–≥–æ–ª —Ö—ç–ª—ç—ç—Ä —è—Ä—å. –ë–æ—Ä–ª—É—É–ª–∞–ª—Ç—ã–Ω –∞—Ä–≥–∞ –±–∞—Ä–∏–ª—ã–≥ —Ü—ç–≥—Ü—Ç—ç–π –∞–≤—á —Ö–∞–¥–≥–∞–ª.`

// POST - Admin AI-—Ç–∞–π —á–∞—Ç–ª–∞—Ö, –º—ç–¥–ª—ç–≥ –Ω—ç–º—ç—Ö
export async function POST(request: NextRequest) {
  try {
    const supabase = createServerClient()
    const { message, history, trainingType } = await request.json()

    if (!message) {
      return NextResponse.json({ error: 'message required' }, { status: 400 })
    }

    // Training type-–¥ —Ç–æ—Ö–∏—Ä–æ—Ö prompt —Å–æ–Ω–≥–æ—Ö
    const systemPrompt = trainingType === 'sales' ? salesPrompt : researchPrompt
    const defaultCategory = trainingType === 'sales' ? 'sales' : 'research'

    const messages: Array<{ role: 'system' | 'user' | 'assistant', content: string }> = [
      { role: 'system', content: systemPrompt },
      ...(history || []).map((m: any) => ({
        role: m.role as 'user' | 'assistant',
        content: m.content
      })),
      { role: 'user', content: message }
    ]

    const response = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages,
      temperature: 0.7,
      max_tokens: 1000
    })

    let aiResponse = response.choices[0].message.content || ''
    let knowledgeAdded = false

    // JSON —Ö–∞—Ä–∏—É–ª—Ç –±–∞–π–≤–∞–ª –º—ç–¥–ª—ç–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö
    try {
      if (aiResponse.includes('"save": true') || aiResponse.includes('"save":true')) {
        const jsonMatch = aiResponse.match(/\{[\s\S]*"save"[\s\S]*\}/)
        if (jsonMatch) {
          const saveData = JSON.parse(jsonMatch[0])
          if (saveData.save && saveData.content) {
            await supabase.from('ai_base_knowledge').insert({
              category: saveData.category || defaultCategory,
              title: saveData.title || '–®–∏–Ω—ç –º—ç–¥–ª—ç–≥',
              content: saveData.content,
              is_active: true
            })
            knowledgeAdded = true
            aiResponse = `‚úÖ –ú—ç–¥–ª—ç–≥ –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ö–∞–¥–≥–∞–ª–∞–≥–¥–ª–∞–∞!\n\nüìö **${saveData.title}**\n${saveData.content}\n\n”®”©—Ä —é—É –∑–∞–∞—Ö –≤—ç?`
          }
        }
      }
    } catch (e) {
      // JSON parse –∞–ª–¥–∞–∞ - —Ö—ç–≤–∏–π–Ω —Ö–∞—Ä–∏—É–ª—Ç –±—É—Ü–∞–∞–Ω–∞
    }

    return NextResponse.json({
      success: true,
      response: aiResponse,
      knowledge_added: knowledgeAdded
    })

  } catch (error) {
    console.error('Admin chat error:', error)
    return NextResponse.json({ error: 'Chat failed' }, { status: 500 })
  }
}
